<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Savings Goal Tracker | Bradley's Financial Tools</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/icons/icon-192.png" type="image/png" />
  <meta name="theme-color" content="#007bff">
  
  <script src="/config.js"></script>
  <script src="/utils/backButtonHandler.js"></script>
  <script type="module" src="/firebase-config.js"></script>
  <script src="/utils/validation.js"></script>
  <script src="/utils/errorHandler.js"></script>
  <script src="/utils/performance.js"></script>
  <script src="/utils/themeManager.js"></script>
  <script src="/utils/authHelper.js"></script>
  <script src="/utils/dataService.js"></script>
  <script type="module" src="/auth.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; min-height: 100vh; }
    .page-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 1rem; }
    .page-title { display: flex; align-items: center; gap: 1rem; }
    .page-title h1 { font-size: 2rem; font-weight: 700; color: #1e293b; }
    .back-btn { background: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; transition: background 0.2s; }
    .back-btn:hover { background: #0056b3; }
    .content-area { background: white; border-radius: 0.75rem; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .goals-table-wrapper { 
      margin-top: 1rem; 
      overflow-x: auto; 
      overflow-y: auto;
      max-height: 70vh;
      border: 1px solid #e2e8f0; 
      border-radius: 0.5rem;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .goals-table-wrapper::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .goals-table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }
    .goals-table-wrapper::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 6px;
    }
    .goals-table-wrapper::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    .goals-table { width: 100%; border-collapse: collapse; background: white; font-size: 0.95rem; min-width: 1000px; }
    .goals-table thead { background: #f8fafc; border-bottom: 2px solid #e2e8f0; }
    .goals-table th { padding: 0.875rem 1rem; text-align: left; font-weight: 600; color: #1e293b; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
    .goals-table td { padding: 0.875rem 1rem; border-bottom: 1px solid #e2e8f0; color: #1e293b; }
    .goals-table tbody tr:hover { background: #f8fafc; }
    .goals-table tbody tr.completed { background: #f0fff4; }
    .goals-table tbody tr.completed td { color: #155724; }
    .progress-bar-cell { min-width: 100px; }
    .progress-bar-inline { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-fill-inline { height: 100%; background: linear-gradient(90deg, #007bff 0%, #0056b3 100%); transition: width 0.3s ease; }
    .progress-fill-inline.completed { background: linear-gradient(90deg, #28a745 0%, #218838 100%); }
    .priority-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .priority-low { background: #e3f2fd; color: #1976d2; }
    .priority-medium { background: #fff3e0; color: #f57c00; }
    .priority-high { background: #ffebee; color: #d32f2f; }
    .status-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-progress { background: #d1ecf1; color: #0c5460; }
    .table-actions { display: flex; gap: 0.5rem; }
    .table-actions .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .goal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .goal-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; }
    .goal-actions { display: flex; gap: 0.5rem; }
    .goal-actions .btn { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .goal-progress { margin-bottom: 1rem; }
    .progress-info { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.875rem; color: #64748b; }
    .progress-bar { width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; border-radius: 6px; }
    .progress-fill.completed { background: linear-gradient(90deg, #28a745 0%, #20c997 100%); }
    .goal-details { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; font-size: 0.875rem; }
    .goal-detail { }
    .goal-detail-label { color: #64748b; margin-bottom: 0.25rem; }
    .goal-detail-value { font-weight: 600; color: #1e293b; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
    .empty-state h3 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #1e293b; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 2rem; border-radius: 0.75rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h2 { font-size: 1.5rem; color: #1e293b; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b; }
    .close-btn:hover { color: #1e293b; }
    .form-group { margin-bottom: 1.5rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #1e293b; }
    .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; }
    .error-message { background: #fee; color: #c33; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .success-message { background: #efe; color: #3c3; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    .loading { text-align: center; padding: 2rem; color: #64748b; }
    @media (max-width: 768px) {
      .goals-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="page-header">
      <div class="page-title">
        <span style="font-size: 2rem;">üéØ</span>
        <h1>Savings Goal Tracker</h1>
      </div>
      <a href="/dashboard.html" class="back-btn">‚Üê Back to Home</a>
    </div>
    
    <div class="content-area">
      <div class="action-bar">
        <h2 style="font-size: 1.5rem; color: #1e293b;">Your Savings Goals</h2>
        <button class="btn btn-primary" onclick="openAddGoalModal()">+ Add Goal</button>
      </div>
      
      <div id="messageContainer"></div>
      
      <div id="goalsContainer">
        <div class="loading">Loading savings goals...</div>
      </div>
    </div>
  </div>
  
  <!-- Add/Edit Goal Modal -->
  <div id="goalModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Add Savings Goal</h2>
        <button class="close-btn" onclick="closeGoalModal()">&times;</button>
      </div>
      <form id="goalForm" onsubmit="saveGoal(event)">
        <div class="form-group">
          <label for="goalName">Goal Name *</label>
          <input type="text" id="goalName" name="name" required placeholder="e.g., Emergency Fund, Vacation">
        </div>
        <div class="form-group">
          <label for="goalTarget">Target Amount *</label>
          <input type="number" id="goalTarget" name="targetAmount" required min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label for="goalCurrent">Current Amount</label>
          <input type="number" id="goalCurrent" name="currentAmount" min="0" step="0.01" placeholder="0.00" value="0">
        </div>
        <div class="form-group">
          <label for="goalTargetDate">Target Date (Optional)</label>
          <input type="date" id="goalTargetDate" name="targetDate" onchange="calculateMonthlyPayment()">
          <div id="monthlyPaymentInfo" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: #e7f3ff; border-radius: 0.5rem; border-left: 4px solid #007bff;">
            <div style="font-size: 0.875rem; color: #004085;">
              <strong>Required Monthly Payment:</strong> 
              <span id="monthlyPaymentAmount" style="font-size: 1.1rem; font-weight: 700; color: #007bff;">$0.00</span>
            </div>
            <div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;" id="monthlyPaymentDetails"></div>
          </div>
        </div>
        <div class="form-group">
          <label for="goalPriority">Priority</label>
          <select id="goalPriority" name="priority">
            <option value="1">Low</option>
            <option value="2" selected>Medium</option>
            <option value="3">High</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeGoalModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Goal</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    let goals = [];
    let editingGoalId = null;
    
    // Wait for DataService and auth to be ready
    async function init() {
      try {
        await waitForAuth(5000);
        if (!window.DataService) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        if (window.DataService) {
          // Check for challenge parameters in URL and create goal first
          await checkChallengeParams();
          // Then load all goals (including the newly created one)
          await loadGoals();
        } else {
          showError('DataService not available. Please refresh the page.');
        }
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize. Please refresh the page.');
      }
    }
    
    // Check URL parameters for challenge and auto-create goal
    async function checkChallengeParams() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const challengeId = urlParams.get('challenge');
        const challengeName = urlParams.get('name');
        const challengeTarget = urlParams.get('target');
        
        if (challengeId && challengeName && challengeTarget) {
          // Check if goal already exists
          const existingGoals = await window.DataService.getSavingsGoals();
          const goalExists = existingGoals.some(goal => 
            goal.name && goal.name.toLowerCase().includes(challengeId.toLowerCase())
          );
          
          if (!goalExists) {
            // Auto-create the goal
            const goalData = {
              name: challengeName,
              targetAmount: parseFloat(challengeTarget),
              currentAmount: 0,
              targetDate: null,
              priority: 2 // Medium priority
            };
            
            await window.DataService.addSavingsGoal(goalData);
            
            // Show success message
            showSuccess(`Challenge "${challengeName}" has been created! Start tracking your progress.`);
            
            // Clean URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
          } else {
            showSuccess(`Challenge "${challengeName}" is already being tracked.`);
            // Clean URL parameters
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        }
      } catch (error) {
        console.error('Error checking challenge params:', error);
        showError('Failed to create challenge: ' + (error.message || 'Please try again.'));
      }
    }
    
    async function loadGoals() {
      try {
        const container = document.getElementById('goalsContainer');
        container.innerHTML = '<div class="loading">Loading savings goals...</div>';
        
        goals = await window.DataService.getSavingsGoals();
        renderGoals();
      } catch (error) {
        console.error('Error loading goals:', error);
        showError('Failed to load goals. ' + error.message);
        document.getElementById('goalsContainer').innerHTML = '<div class="empty-state"><h3>Error loading goals</h3><p>Please try refreshing the page.</p></div>';
      }
    }
    
    function renderGoals() {
      const container = document.getElementById('goalsContainer');
      
      if (goals.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Savings Goals</h3><p>Click "Add Goal" to start tracking your savings progress.</p></div>';
        return;
      }
      
      const tableRows = goals.map(goal => {
        const target = goal.targetAmount || 0;
        const current = goal.currentAmount || 0;
        const remaining = Math.max(0, target - current);
        const percentage = target > 0 ? Math.min((current / target) * 100, 100) : 0;
        const isCompleted = current >= target;
        
        let targetDateStr = 'N/A';
        if (goal.targetDate) {
          const date = goal.targetDate.toDate ? goal.targetDate.toDate() : new Date(goal.targetDate);
          targetDateStr = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        const priorityLabels = { 1: 'Low', 2: 'Medium', 3: 'High' };
        const priority = priorityLabels[goal.priority] || 'Medium';
        const priorityClass = goal.priority === 1 ? 'priority-low' : (goal.priority === 3 ? 'priority-high' : 'priority-medium');
        
        // Calculate monthly payment if target date is set
        let monthlyPaymentStr = 'N/A';
        if (goal.targetDate) {
          const targetDate = goal.targetDate.toDate ? goal.targetDate.toDate() : new Date(goal.targetDate);
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const targetDateOnly = new Date(targetDate);
          targetDateOnly.setHours(0, 0, 0, 0);
          
          if (targetDateOnly > today && remaining > 0) {
            const yearsDiff = targetDateOnly.getFullYear() - today.getFullYear();
            const monthsDiff = targetDateOnly.getMonth() - today.getMonth();
            const daysDiff = targetDateOnly.getDate() - today.getDate();
            let totalMonths = yearsDiff * 12 + monthsDiff;
            if (daysDiff < 0) totalMonths -= 1;
            
            if (totalMonths >= 1) {
              const monthlyPayment = remaining / totalMonths;
              monthlyPaymentStr = window.DataService.formatCurrency(monthlyPayment);
            } else if (totalMonths >= 0) {
              const daysUntilTarget = Math.ceil((targetDateOnly - today) / (1000 * 60 * 60 * 24));
              const dailyPayment = remaining / daysUntilTarget;
              monthlyPaymentStr = window.DataService.formatCurrency(dailyPayment * 30) + ' (~' + window.DataService.formatCurrency(dailyPayment) + '/day)';
            }
          }
        }
        
        return `
          <tr class="${isCompleted ? 'completed' : ''}">
            <td><strong>${escapeHtml(goal.name)}</strong></td>
            <td>${window.DataService.formatCurrency(current)}</td>
            <td>${window.DataService.formatCurrency(target)}</td>
            <td>${window.DataService.formatCurrency(remaining)}</td>
            <td class="progress-bar-cell">
              <div class="progress-bar-inline">
                <div class="progress-fill-inline ${isCompleted ? 'completed' : ''}" style="width: ${percentage}%"></div>
              </div>
              <span style="font-size: 0.875rem; color: #64748b; margin-top: 0.25rem; display: block;">${percentage.toFixed(1)}%</span>
            </td>
            <td>${targetDateStr}</td>
            <td><span class="priority-badge priority-${priorityClass.toLowerCase()}">${priority}</span></td>
            <td><span class="status-badge ${isCompleted ? 'status-completed' : 'status-progress'}">${isCompleted ? 'Completed' : 'In Progress'}</span></td>
            <td>${monthlyPaymentStr}</td>
            <td>
              <div class="table-actions">
                <button class="btn btn-primary" onclick="editGoal('${goal.id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteGoal('${goal.id}')">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
      
      container.innerHTML = `
        <div class="goals-table-wrapper">
          <table class="goals-table">
            <thead>
              <tr>
                <th>Goal Name</th>
                <th>Current</th>
                <th>Target</th>
                <th>Remaining</th>
                <th>Progress</th>
                <th>Target Date</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Monthly Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
      `;
    }
    
    function openAddGoalModal() {
      editingGoalId = null;
      document.getElementById('modalTitle').textContent = 'Add Savings Goal';
      document.getElementById('goalForm').reset();
      document.getElementById('goalPriority').value = '2';
      document.getElementById('monthlyPaymentInfo').style.display = 'none';
      document.getElementById('goalModal').classList.add('active');
      // Re-setup event listeners after modal opens
      setTimeout(setupMonthlyPaymentCalculation, 100);
    }
    
    function editGoal(goalId) {
      const goal = goals.find(g => g.id === goalId);
      if (!goal) return;
      
      editingGoalId = goalId;
      document.getElementById('modalTitle').textContent = 'Edit Savings Goal';
      document.getElementById('goalName').value = goal.name;
      document.getElementById('goalTarget').value = goal.targetAmount || 0;
      document.getElementById('goalCurrent').value = goal.currentAmount || 0;
      document.getElementById('goalPriority').value = goal.priority || 2;
      
      if (goal.targetDate) {
        const date = goal.targetDate.toDate ? goal.targetDate.toDate() : new Date(goal.targetDate);
        document.getElementById('goalTargetDate').value = date.toISOString().split('T')[0];
      } else {
        document.getElementById('goalTargetDate').value = '';
      }
      
      document.getElementById('goalModal').classList.add('active');
      // Re-setup event listeners and calculate monthly payment
      setTimeout(() => {
        setupMonthlyPaymentCalculation();
        calculateMonthlyPayment();
      }, 100);
    }
    
    function closeGoalModal() {
      document.getElementById('goalModal').classList.remove('active');
      editingGoalId = null;
      document.getElementById('goalForm').reset();
    }
    
    async function saveGoal(event) {
      event.preventDefault();
      
      const targetDateValue = document.getElementById('goalTargetDate').value;
      const targetDate = targetDateValue ? new Date(targetDateValue) : null;
      
      const formData = {
        name: document.getElementById('goalName').value.trim(),
        targetAmount: parseFloat(document.getElementById('goalTarget').value),
        currentAmount: parseFloat(document.getElementById('goalCurrent').value || 0),
        targetDate: targetDate,
        priority: parseInt(document.getElementById('goalPriority').value || 2)
      };
      
      if (!formData.name || formData.targetAmount < 0 || formData.currentAmount < 0) {
        showError('Please fill in all required fields with valid values.');
        return;
      }
      
      try {
        if (editingGoalId) {
          await window.DataService.updateSavingsGoal(editingGoalId, formData);
          showSuccess('Goal updated successfully!');
        } else {
          await window.DataService.addSavingsGoal(formData);
          showSuccess('Goal added successfully!');
        }
        
        closeGoalModal();
        await loadGoals();
      } catch (error) {
        console.error('Error saving goal:', error);
        showError('Failed to save goal. ' + error.message);
      }
    }
    
    async function deleteGoal(goalId) {
      if (!confirm('Are you sure you want to delete this savings goal?')) return;
      
      try {
        await window.DataService.deleteSavingsGoal(goalId);
        showSuccess('Goal deleted successfully!');
        await loadGoals();
      } catch (error) {
        console.error('Error deleting goal:', error);
        showError('Failed to delete goal. ' + error.message);
      }
    }
    
    function showError(message) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }
    
    function showSuccess(message) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="success-message">${escapeHtml(message)}</div>`;
      setTimeout(() => container.innerHTML = '', 3000);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function calculateMonthlyPayment() {
      const targetDateInput = document.getElementById('goalTargetDate');
      const targetAmountInput = document.getElementById('goalTarget');
      const currentAmountInput = document.getElementById('goalCurrent');
      const monthlyPaymentInfo = document.getElementById('monthlyPaymentInfo');
      const monthlyPaymentAmount = document.getElementById('monthlyPaymentAmount');
      const monthlyPaymentDetails = document.getElementById('monthlyPaymentDetails');
      
      const targetDateValue = targetDateInput.value;
      const targetAmount = parseFloat(targetAmountInput.value || 0);
      const currentAmount = parseFloat(currentAmountInput.value || 0);
      
      // Hide if no target date or invalid values
      if (!targetDateValue || isNaN(targetAmount) || isNaN(currentAmount) || targetAmount <= 0) {
        monthlyPaymentInfo.style.display = 'none';
        return;
      }
      
      const targetDate = new Date(targetDateValue);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      targetDate.setHours(0, 0, 0, 0);
      
      // Check if target date is in the past
      if (targetDate < today) {
        monthlyPaymentInfo.style.display = 'block';
        monthlyPaymentAmount.textContent = 'N/A';
        monthlyPaymentDetails.textContent = 'Target date is in the past. Please select a future date.';
        monthlyPaymentInfo.style.background = '#fff3cd';
        monthlyPaymentInfo.style.borderLeftColor = '#ffc107';
        return;
      }
      
      const remainingAmount = targetAmount - currentAmount;
      
      if (remainingAmount <= 0) {
        monthlyPaymentInfo.style.display = 'block';
        monthlyPaymentAmount.textContent = '$0.00';
        monthlyPaymentDetails.textContent = 'Goal already reached!';
        monthlyPaymentInfo.style.background = '#d4edda';
        monthlyPaymentInfo.style.borderLeftColor = '#28a745';
        return;
      }
      
      // Calculate months between today and target date
      const yearsDiff = targetDate.getFullYear() - today.getFullYear();
      const monthsDiff = targetDate.getMonth() - today.getMonth();
      const daysDiff = targetDate.getDate() - today.getDate();
      
      // Calculate total months (including partial months)
      let totalMonths = yearsDiff * 12 + monthsDiff;
      if (daysDiff < 0) {
        totalMonths -= 1;
      }
      
      // If less than 1 month, use days
      if (totalMonths < 1) {
        const daysUntilTarget = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        const dailyPayment = remainingAmount / daysUntilTarget;
        const monthlyPayment = dailyPayment * 30; // Approximate monthly
        monthlyPaymentInfo.style.display = 'block';
        monthlyPaymentAmount.textContent = window.DataService.formatCurrency(monthlyPayment);
        monthlyPaymentDetails.textContent = `You need to save ${window.DataService.formatCurrency(dailyPayment)} per day (${daysUntilTarget} days remaining)`;
        monthlyPaymentInfo.style.background = '#e7f3ff';
        monthlyPaymentInfo.style.borderLeftColor = '#007bff';
        return;
      }
      
      // Calculate monthly payment
      const monthlyPayment = remainingAmount / totalMonths;
      
      // Display the result
      monthlyPaymentInfo.style.display = 'block';
      monthlyPaymentAmount.textContent = window.DataService.formatCurrency(monthlyPayment);
      
      const monthsText = totalMonths === 1 ? 'month' : 'months';
      monthlyPaymentDetails.textContent = `You need to save this amount each month for ${totalMonths} ${monthsText} to reach your goal.`;
      monthlyPaymentInfo.style.background = '#e7f3ff';
      monthlyPaymentInfo.style.borderLeftColor = '#007bff';
    }
    
    // Add event listeners to recalculate when target amount or current amount changes
    function setupMonthlyPaymentCalculation() {
      const targetAmountInput = document.getElementById('goalTarget');
      const currentAmountInput = document.getElementById('goalCurrent');
      
      if (targetAmountInput) {
        targetAmountInput.addEventListener('input', calculateMonthlyPayment);
      }
      if (currentAmountInput) {
        currentAmountInput.addEventListener('input', calculateMonthlyPayment);
      }
    }
    
    // Close modal when clicking outside
    document.getElementById('goalModal').addEventListener('click', function(e) {
      if (e.target === this) closeGoalModal();
    });
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function() {
      init();
      setupMonthlyPaymentCalculation();
    });
  </script>
</body>
</html>
