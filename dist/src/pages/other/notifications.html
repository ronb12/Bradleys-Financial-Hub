<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>Notifications | Bradley's Financial Tools</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/icons/icon-192.png" type="image/png" />
  <meta name="theme-color" content="#007bff">
  
  <script src="/config.js"></script>
  <script type="module" src="/firebase-config.js"></script>
  <script src="/utils/validation.js"></script>
  <script src="/utils/errorHandler.js"></script>
  <script src="/utils/performance.js"></script>
  <script src="/utils/themeManager.js"></script>
  <script src="/utils/authHelper.js"></script>
  <script src="/utils/dataService.js"></script>
  <script type="module" src="/auth.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; min-height: 100vh; }
    .page-container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e2e8f0; flex-wrap: wrap; gap: 1rem; }
    .page-title { display: flex; align-items: center; gap: 1rem; }
    .page-title h1 { font-size: 2rem; font-weight: 700; color: #1e293b; }
    .back-btn { background: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; transition: background 0.2s; }
    .back-btn:hover { background: #0056b3; }
    .content-area { background: white; border-radius: 0.75rem; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }
    .notifications-list { margin-top: 1rem; }
    .notification-item { display: flex; align-items: flex-start; padding: 1.5rem; border-bottom: 1px solid #e2e8f0; transition: background 0.2s; position: relative; }
    .notification-item:hover { background: #f8fafc; }
    .notification-item:last-child { border-bottom: none; }
    .notification-item.unread { background: #f0f7ff; border-left: 4px solid #007bff; }
    .notification-icon { font-size: 2rem; margin-right: 1rem; width: 48px; text-align: center; flex-shrink: 0; }
    .notification-content { flex: 1; }
    .notification-title { font-size: 1.125rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem; }
    .notification-description { color: #64748b; font-size: 0.875rem; margin-bottom: 0.5rem; line-height: 1.5; }
    .notification-meta { display: flex; align-items: center; gap: 1rem; font-size: 0.875rem; color: #64748b; }
    .notification-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .btn-small { padding: 0.5rem 1rem; font-size: 0.875rem; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #64748b; }
    .empty-state h3 { font-size: 1.5rem; margin-bottom: 0.5rem; color: #1e293b; }
    .loading { text-align: center; padding: 2rem; color: #64748b; }
    .error-message { background: #fee; color: #c33; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    @media (max-width: 768px) {
      .notification-item { flex-direction: column; }
      .notification-icon { margin-bottom: 0.5rem; }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="page-header">
      <div class="page-title">
        <span style="font-size: 2rem;">üîî</span>
        <h1>Notifications</h1>
      </div>
      <a href="/index.html" class="back-btn">‚Üê Back to Home</a>
    </div>
    
    <div class="content-area">
      <div class="action-bar">
        <h2 style="font-size: 1.5rem; color: #1e293b;">Your Notifications</h2>
        <button class="btn btn-secondary" onclick="markAllAsRead()">Mark All Read</button>
      </div>
      
      <div id="messageContainer"></div>
      
      <div id="notificationsContainer">
        <div class="loading">Loading notifications...</div>
      </div>
    </div>
  </div>
  
  <script>
    let notifications = [];
    
    // Wait for DataService and auth to be ready
    async function init() {
      try {
        await waitForAuth(5000);
        if (!window.DataService) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        if (window.DataService) {
          loadNotifications();
        } else {
          showError('DataService not available. Please refresh the page.');
        }
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize. Please refresh the page.');
      }
    }
    
    async function loadNotifications() {
      try {
        const container = document.getElementById('notificationsContainer');
        container.innerHTML = '<div class="loading">Loading notifications...</div>';
        
        // Generate notifications from financial data
        await generateNotifications();
        
        // Sort by date (newest first)
        notifications.sort((a, b) => {
          const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
          const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
          return dateB - dateA;
        });
        
        renderNotifications();
      } catch (error) {
        console.error('Error loading notifications:', error);
        showError('Failed to load notifications. ' + error.message);
        document.getElementById('notificationsContainer').innerHTML = '<div class="empty-state"><h3>Error loading notifications</h3><p>Please try refreshing the page.</p></div>';
      }
    }
    
    function formatCurrency(amount) {
      // Helper function for currency formatting
      if (window.DataService && window.DataService.formatCurrency) {
        return window.DataService.formatCurrency(amount);
      }
      return '$' + parseFloat(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    async function generateNotifications() {
      notifications = [];
      
      try {
        // Check for budget alerts
        try {
          const budgets = await window.DataService.getBudgets();
          if (Array.isArray(budgets)) {
            budgets.forEach(budget => {
              const budgeted = budget.budgetedAmount || 0;
              const spent = budget.spentAmount || 0;
              const percentage = budgeted > 0 ? (spent / budgeted) * 100 : 0;
              
              if (percentage >= 100) {
                notifications.push({
                  id: 'budget-over-' + budget.id,
                  type: 'budget',
                  title: `Budget Alert: ${budget.category}`,
                  description: `You've exceeded your budget for ${budget.category}. You've spent ${formatCurrency(spent)} of ${formatCurrency(budgeted)}.`,
                  date: budget.updatedAt || budget.createdAt,
                  read: false,
                  priority: 'high'
                });
              } else if (percentage >= 80) {
                notifications.push({
                  id: 'budget-warning-' + budget.id,
                  type: 'budget',
                  title: `Budget Warning: ${budget.category}`,
                  description: `You're approaching your budget limit for ${budget.category}. You've spent ${percentage.toFixed(0)}% of your budget.`,
                  date: budget.updatedAt || budget.createdAt,
                  read: false,
                  priority: 'medium'
                });
              }
            });
          }
        } catch (error) {
          console.warn('Error loading budgets for notifications:', error);
        }
        
        // Check for savings goal milestones
        try {
          const goals = await window.DataService.getSavingsGoals();
          if (Array.isArray(goals)) {
            goals.forEach(goal => {
              const target = goal.targetAmount || 0;
              const current = goal.currentAmount || 0;
              const percentage = target > 0 ? (current / target) * 100 : 0;
              
              if (percentage >= 100) {
                notifications.push({
                  id: 'goal-complete-' + goal.id,
                  type: 'goal',
                  title: `üéâ Goal Achieved: ${goal.name}`,
                  description: `Congratulations! You've reached your savings goal of ${formatCurrency(target)}.`,
                  date: goal.updatedAt || goal.createdAt,
                  read: false,
                  priority: 'high'
                });
              } else if (percentage >= 75) {
                notifications.push({
                  id: 'goal-milestone-' + goal.id,
                  type: 'goal',
                  title: `Milestone: ${goal.name}`,
                  description: `You're ${percentage.toFixed(0)}% toward your goal of ${formatCurrency(target)}. Keep going!`,
                  date: goal.updatedAt || goal.createdAt,
                  read: false,
                  priority: 'low'
                });
              }
            });
          }
        } catch (error) {
          console.warn('Error loading savings goals for notifications:', error);
        }
        
        // Check for high-interest debts
        try {
          const debts = await window.DataService.getDebts();
          if (Array.isArray(debts)) {
            debts.forEach(debt => {
              if (debt.interestRate > 15) {
                notifications.push({
                  id: 'debt-high-interest-' + debt.id,
                  type: 'debt',
                  title: `High Interest Debt: ${debt.name}`,
                  description: `${debt.name} has a high interest rate of ${debt.interestRate.toFixed(2)}%. Consider paying this off first.`,
                  date: debt.updatedAt || debt.createdAt,
                  read: false,
                  priority: 'medium'
                });
              }
            });
          }
        } catch (error) {
          console.warn('Error loading debts for notifications:', error);
        }
        
        // Add welcome notification if no other notifications
        if (notifications.length === 0) {
          notifications.push({
            id: 'welcome',
            type: 'info',
            title: 'Welcome to Bradley\'s Financial Tools!',
            description: 'Start by adding a budget, tracking a debt, or setting a savings goal. Your financial notifications will appear here.',
            date: new Date(),
            read: false,
            priority: 'low'
          });
        }
      } catch (error) {
        console.error('Error generating notifications:', error);
        // Even if there's an error, show welcome notification
        if (notifications.length === 0) {
          notifications.push({
            id: 'welcome',
            type: 'info',
            title: 'Welcome to Bradley\'s Financial Tools!',
            description: 'Start by adding a budget, tracking a debt, or setting a savings goal. Your financial notifications will appear here.',
            date: new Date(),
            read: false,
            priority: 'low'
          });
        }
      }
    }
    
    function renderNotifications() {
      const container = document.getElementById('notificationsContainer');
      
      if (notifications.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>No Notifications</h3><p>You are all caught up! New notifications will appear here.</p></div>';
        return;
      }
      
      const icons = {
        'budget': 'üí∞',
        'goal': 'üéØ',
        'debt': 'üìã',
        'info': '‚ÑπÔ∏è',
        'default': 'üîî'
      };
      
      const unreadCount = notifications.filter(n => !n.read).length;
      
      const notificationsHtml = notifications.map(notification => {
        const date = notification.date?.toDate ? notification.date.toDate() : new Date(notification.date);
        const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        const icon = icons[notification.type] || icons['default'];
        const unreadClass = notification.read ? '' : 'unread';
        
        // Priority styling
        let priorityBadge = '';
        if (notification.priority) {
          const priorityColors = {
            'high': { bg: '#fee', color: '#721c24' },
            'medium': { bg: '#fff3cd', color: '#856404' },
            'low': { bg: '#d4edda', color: '#155724' }
          };
          const colors = priorityColors[notification.priority] || priorityColors.low;
          priorityBadge = '<span style="padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; background: ' + colors.bg + '; color: ' + colors.color + ';">' + notification.priority.toUpperCase() + '</span>';
        }
        
        // Mark Read button
        const markReadButton = !notification.read ? '<button class="btn btn-primary btn-small" onclick="markAsRead(\'' + notification.id + '\')">Mark Read</button>' : '';
        
        return `
          <div class="notification-item ${unreadClass}">
            <div class="notification-icon">${icon}</div>
            <div class="notification-content">
              <div class="notification-title">${escapeHtml(notification.title)}</div>
              <div class="notification-description">${escapeHtml(notification.description)}</div>
              <div class="notification-meta">
                <span>${dateStr} at ${timeStr}</span>
                ${priorityBadge}
              </div>
              <div class="notification-actions">
                ${markReadButton}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      // Build unread count message
      let unreadMessage = '';
      if (unreadCount > 0) {
        const plural = unreadCount !== 1 ? 's' : '';
        unreadMessage = '<div style="margin-bottom: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 0.5rem; color: #004085;">You have ' + unreadCount + ' unread notification' + plural + '.</div>';
      }
      
      container.innerHTML = unreadMessage + '<div class="notifications-list">' + notificationsHtml + '</div>';
    }
    
    function markAsRead(notificationId) {
      const notification = notifications.find(n => n.id === notificationId);
      if (notification) {
        notification.read = true;
        renderNotifications();
      }
    }
    
    function markAllAsRead() {
      notifications.forEach(n => n.read = true);
      renderNotifications();
    }
    
    function showError(message) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
